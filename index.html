<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>2FA 验证工具</title>
    <style>
        body{font-family:Arial,sans-serif;background-color:#f4f6f8;display:flex;justify-content:center;align-items:center;min-height:100vh;padding:20px}
        .container{background:#fff;padding:30px 40px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.1);max-width:400px;width:100%;position:relative}
        h2{text-align:center;margin-bottom:25px;color:#333}
        .form-group{margin-bottom:20px}
        label{display:block;margin-bottom:8px;color:#555}
        input[type=text]{width:calc(100% - 24px);padding:10px 12px;border:1px solid #ccc;border-radius:5px;box-sizing:border-box;font-size:14px}
        input[type=text]:focus{border-color:#66afe9;outline:none}
        button{padding:10px 20px;background:#007bff;border:none;border-radius:5px;color:#fff;font-size:14px;cursor:pointer;margin-top:10px;width:100%;transition:background-color 0.3s}
        button:hover{background:#0069d9}
        .code-display{background:#f9f9f9;padding:15px;border-radius:5px;text-align:center;margin-bottom:20px;cursor:pointer;transition:background-color 0.5s,opacity 0.5s}
        .code-display h3{margin:0;font-size:32px;color:#333;transition:color 0.5s}
        .countdown{font-size:14px;color:#888;margin-top:5px}
        .note{font-size:12px;color:#888;text-align:center;margin-top:15px}
        .success-message{position:absolute;top:10px;right:10px;background:#d4edda;color:#155724;padding:10px 15px;border:1px solid #c3e6cb;border-radius:5px;opacity:0;transition:opacity 0.5s}
        .success-message.show{opacity:1}
    </style>
</head>
<body>
    <div class="container">
        <div class="success-message" id="successMessage">已成功获取验证码哦~</div>
        <h2>2FA 验证工具</h2>
        <div class="form-group">
            <label for="inputSecret">输入您的2FA密钥:</label>
            <input type="text" id="inputSecret" placeholder="输入您的密钥" required>
            <button id="setSecret">设置密钥</button>
        </div>
        <div class="form-group">
            <label>当前验证码:</label>
            <div class="code-display" id="currentCode" title="点击复制验证码">
                <h3>------</h3>
                <div class="countdown" id="countdown">剩余时间: 30 秒</div>
            </div>
        </div>
        <div class="note">
            新手提示：必须在倒计时结束前输入验证码登录或验证，否则会失效显示错误。测试功能时必须输入正确编码的密钥，不要随便输入1串字符测试获取功能。目前点击“设置密钥”按钮后会自动复制验证码到剪贴板，直接去粘贴即可。<br>
            最近维护：2024年10月19日
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsSHA/3.2.0/sha.js"></script>
    <script>
        function base32tohex(base32){const b="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";let bits="",hex="";base32=base32.toUpperCase().replace(/=+$/,'');for(let i=0;i<base32.length;i++){const val=b.indexOf(base32.charAt(i));if(val==-1){continue}bits+=val.toString(2).padStart(5,'0')}for(let i=0;i+4<=bits.length;i+=4){const chunk=bits.substr(i,4);hex+=parseInt(chunk,2).toString(16)}return hex}
        function getTOTP(secret){const key=base32tohex(secret);const epoch=Math.floor(new Date().getTime()/1000);const ts=Math.floor(epoch/30);const time=leftpad(dec2hex(ts),16,'0');const shaObj=new jsSHA("SHA-1","HEX");shaObj.setHMACKey(key,"HEX");shaObj.update(time);const hmac=shaObj.getHMAC("HEX");const offset=hex2dec(hmac.substr(hmac.length-1,1));const otp=(hex2dec(hmac.substr(offset*2,8))&0x7fffffff)+"";return otp.substr(otp.length-6,6)}
        function dec2hex(s){return (s<15.5?"0":"")+Math.round(s).toString(16)}
        function hex2dec(s){return parseInt(s,16)}
        function leftpad(str,len,pad){return Array(len-str.length+1).join(pad)+str}
        let countdownInterval,currentSecret="",currentCode="------";
        function updateCode(){const now=Math.floor(new Date().getTime()/1000);const ts=Math.floor(now/30);const next=(ts+1)*30;const rem=next-now;if(currentSecret!==""){const newCode=getTOTP(currentSecret);if(newCode!==currentCode){currentCode=newCode;const ce=document.getElementById('currentCode').querySelector('h3');ce.innerText=currentCode;const cd=document.getElementById('currentCode');cd.style.backgroundColor='#d4edda';ce.style.color='#155724';setTimeout(()=>{cd.style.backgroundColor='#f9f9f9';ce.style.color='#333'},500);showSuccess()} } else {currentCode="------";document.getElementById('currentCode').querySelector('h3').innerText=currentCode} document.getElementById('countdown').innerText="剩余时间: "+rem+" 秒";clearTimeout(countdownInterval);countdownInterval=setTimeout(updateCode,1000)}
        function showSuccess(){const sm=document.getElementById('successMessage');sm.classList.add('show');setTimeout(()=>{sm.classList.remove('show')},3000)}
        function copyToClipboard(text){navigator.clipboard.writeText(text).then(()=>{alert("已复制到剪贴板: "+text)},err=>{alert("复制失败: "+err)})}
        document.getElementById('setSecret').addEventListener('click',function(){const s=document.getElementById('inputSecret').value.trim();if(s===""){alert("请输入密钥");return}if(s!==currentSecret){currentSecret=s;currentCode=getTOTP(currentSecret);document.getElementById('currentCode').querySelector('h3').innerText=currentCode;copyToClipboard(currentCode);updateCode();showSuccess()}else{if(currentCode!=="------"){copyToClipboard(currentCode)}}})
        document.getElementById('currentCode').addEventListener('click',function(){if(currentCode!=="------"){copyToClipboard(currentCode)}})
        window.onload=function(){updateCode()}
    </script>
</body>
</html>
